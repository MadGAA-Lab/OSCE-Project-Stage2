name: Publish Agents

# Trigger this workflow when pushing main branch and tags
on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.1.0

jobs:
  publish:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # Update this to build your own agent images.
          # - name: adk-debate-judge
          #   dockerfile: scenarios/debate/Dockerfile.adk-debate-judge
          # - name: debate-judge
          #   dockerfile: scenarios/debate/Dockerfile.debate-judge
          # - name: debater
          #   dockerfile: scenarios/debate/Dockerfile.debater
          # - name: tau2-agent
          #   dockerfile: scenarios/tau2/Dockerfile.tau2-agent
          # - name: tau2-evaluator
          #   dockerfile: scenarios/tau2/Dockerfile.tau2-evaluator
          - name: medical-judge
            dockerfile: scenarios/medical_dialogue/Dockerfile.medical-judge
          - name: doctor-agent
            dockerfile: scenarios/medical_dialogue/Dockerfile.doctor-agent

    # These permissions are required for the workflow to:
    # - Read repository contents (checkout code)
    # - Write to GitHub Container Registry (push Docker images)
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # GITHUB_TOKEN is automatically provided by GitHub Actions
          # No manual secret configuration needed!
          # It has permissions based on the 'permissions' block above
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-${{ matrix.name }}
          tags: |
            # For tags like v1.0, create tag '1.0'
            type=semver,pattern={{version}}
            # For tags like v1.0, create tag '1'
            type=semver,pattern={{major}}
            # For main branch, create tag 'latest'
            type=raw,value=latest,enable={{is_default_branch}}
            # For PRs, create tag 'pr-123'
            type=ref,event=pr

      - name: Build and push Docker image (${{ matrix.name }})
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          # Only push if this is a push event (not a PR)
          # PRs will build but not push to avoid polluting the registry
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Explicitly build for linux/amd64 (GitHub Actions default)
          platforms: linux/amd64

      - name: Output image digest
        if: github.event_name != 'pull_request'
        run: |
          echo "## Docker Image Published: ${{ matrix.name }} :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use this digest in your MANIFEST.json for reproducibility." >> $GITHUB_STEP_SUMMARY

  # Deploy job runs after all images are published
  deploy:
    needs: publish
    runs-on: ubuntu-latest
    # Only deploy on push to main branch or version tags
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        env:
          API_KEY: ${{ secrets.API_KEY }}
          BASE_URL: ${{ secrets.BASE_URL }}
          DEFAULT_MODEL: ${{ secrets.DEFAULT_MODEL }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          PATIENT_API_KEY: ${{ secrets.PATIENT_API_KEY }}
          PATIENT_BASE_URL: ${{ secrets.PATIENT_BASE_URL }}
          PATIENT_MODEL: ${{ secrets.PATIENT_MODEL }}
          PATIENT_AZURE_API_VERSION: ${{ secrets.PATIENT_AZURE_API_VERSION }}
          JUDGE_API_KEY: ${{ secrets.JUDGE_API_KEY }}
          JUDGE_BASE_URL: ${{ secrets.JUDGE_BASE_URL }}
          JUDGE_MODEL: ${{ secrets.JUDGE_MODEL }}
          JUDGE_AZURE_API_VERSION: ${{ secrets.JUDGE_AZURE_API_VERSION }}
          DOCTOR_API_KEY: ${{ secrets.DOCTOR_API_KEY }}
          DOCTOR_BASE_URL: ${{ secrets.DOCTOR_BASE_URL }}
          DOCTOR_MODEL: ${{ secrets.DOCTOR_MODEL }}
          DOCTOR_AZURE_API_VERSION: ${{ secrets.DOCTOR_AZURE_API_VERSION }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          envs: API_KEY,BASE_URL,DEFAULT_MODEL,AZURE_OPENAI_API_VERSION,PATIENT_API_KEY,PATIENT_BASE_URL,PATIENT_MODEL,PATIENT_AZURE_API_VERSION,JUDGE_API_KEY,JUDGE_BASE_URL,JUDGE_MODEL,JUDGE_AZURE_API_VERSION,DOCTOR_API_KEY,DOCTOR_BASE_URL,DOCTOR_MODEL,DOCTOR_AZURE_API_VERSION,GITHUB_REPOSITORY,GITHUB_REF_NAME,GITHUB_TOKEN,GITHUB_ACTOR
          script: |
            export GITHUB_REPOSITORY=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
            export GITHUB_REF_NAME="${GITHUB_REF_NAME}"
            export GITHUB_TOKEN="${GITHUB_TOKEN}"
            export GITHUB_ACTOR="${GITHUB_ACTOR}"
            export API_KEY="${API_KEY}"
            export BASE_URL="${BASE_URL}"
            export DEFAULT_MODEL="${DEFAULT_MODEL}"
            export AZURE_OPENAI_API_VERSION="${AZURE_OPENAI_API_VERSION}"
            export PATIENT_API_KEY="${PATIENT_API_KEY}"
            export PATIENT_BASE_URL="${PATIENT_BASE_URL}"
            export PATIENT_MODEL="${PATIENT_MODEL}"
            export PATIENT_AZURE_API_VERSION="${PATIENT_AZURE_API_VERSION}"
            export JUDGE_API_KEY="${JUDGE_API_KEY}"
            export JUDGE_BASE_URL="${JUDGE_BASE_URL}"
            export JUDGE_MODEL="${JUDGE_MODEL}"
            export JUDGE_AZURE_API_VERSION="${JUDGE_AZURE_API_VERSION}"
            export DOCTOR_API_KEY="${DOCTOR_API_KEY}"
            export DOCTOR_BASE_URL="${DOCTOR_BASE_URL}"
            export DOCTOR_MODEL="${DOCTOR_MODEL}"
            export DOCTOR_AZURE_API_VERSION="${DOCTOR_AZURE_API_VERSION}"
            bash -c "$(curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/deployment/deploy.sh)"

      - name: Deployment summary
        run: |
          echo "## Deployment Complete :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
